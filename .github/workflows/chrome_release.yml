name: Extension Build & Publish to Chrome

on:
    push:
        branches:
            - release

jobs:
    publish:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install dependencies
              run: npm ci

            - name: Build extension
              run: npm run build:chrome

            - name: Create zip for upload
              run: cd build && zip -r ../looi-extension.zip .

            - name: Set up GCP authentication
              uses: google-github-actions/auth@v1
              with:
                  credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

            - name: Get OAuth2 access token
              run: |
                  ACCESS_TOKEN=$(gcloud auth application-default print-access-token)
                  echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV

            - name: Upload & publish to Chrome Web Store
              run: |
                  # Install chrome-webstore-upload-cli if not already installed
                  npm install -g chrome-webstore-upload-cli

                  # Upload the extension using the access token
                  npx chrome-webstore-upload-cli upload \
                      --source looi-extension.zip \
                      --extension-id ${{ secrets.CHROME_EXTENSION_ID }} \
                      --access-token ${{ env.ACCESS_TOKEN }}

                  # Publish the extension (auto-publish after upload)
                  npx chrome-webstore-upload-cli publish \
                      --extension-id ${{ secrets.CHROME_EXTENSION_ID }} \
                      --access-token ${{ env.ACCESS_TOKEN }}
