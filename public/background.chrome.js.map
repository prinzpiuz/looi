{
  "version": 3,
  "sources": ["../src/background_workers/background.chrome.ts"],
  "sourcesContent": ["/* eslint-disable no-unused-vars */\n/* eslint-disable no-undef */\n\n/// <reference types=\"chrome\"/>\nimport {\n    GithubResponses,\n    MessageData,\n    GithubDeviceCodeResponse,\n    GithubTokenResponse,\n    GithubAPIResponse,\n    GithubUnAuthorizedResponse,\n    Settings,\n    GistResponse,\n} from '../utils/types';\n\nconst CLIENT_ID = 'Iv23li5frjjDBAV3DfuR';\n\nconst DeviceBaseFlowURL = 'https://github.com/login/';\nconst GistBaseURL = 'https://api.github.com/gists';\n\nconst settingsToJSONString = (settings: Settings): string => {\n    return JSON.stringify(settings, null, 2); // pretty-print with 2-space indent\n};\nconst getToken = async (): Promise<string> => {\n    return new Promise((resolve, reject) => {\n        chrome.storage.local.get('github_token', (stored) => {\n            if (chrome.runtime.lastError) {\n                reject(chrome.runtime.lastError);\n                return;\n            }\n            resolve((stored?.github_token as string) ?? '');\n        });\n    });\n};\n\nchrome.runtime.onMessage.addListener(\n    (\n        message: MessageData,\n        _sender: chrome.runtime.MessageSender,\n        sendResponse: (response: GithubResponses) => void,\n    ): boolean | void => {\n        if (message.type === 'GITHUB_DEVICE_FLOW') {\n            void (async () => {\n                try {\n                    if (message.action === 'startDeviceFlow') {\n                        // Step 1: Get device/user code\n                        const resp = await fetch(\n                            `${DeviceBaseFlowURL}device/code`,\n                            {\n                                method: 'POST',\n                                headers: {\n                                    'Content-Type':\n                                        'application/x-www-form-urlencoded',\n                                    Accept: 'application/json',\n                                },\n                                body: `client_id=${encodeURIComponent(CLIENT_ID)}&scope=gist`,\n                            },\n                        );\n\n                        if (!resp.ok) {\n                            throw new Error(\n                                `HTTP error! status: ${resp.status}`,\n                            );\n                        }\n\n                        const data: GithubDeviceCodeResponse =\n                            await resp.json();\n                        sendResponse({ success: true, data });\n                    } else if (message.action === 'getToken') {\n                        // Step 2: Poll for access token\n                        const resp = await fetch(\n                            `${DeviceBaseFlowURL}/oauth/access_token`,\n                            {\n                                method: 'POST',\n                                headers: {\n                                    'Content-Type':\n                                        'application/x-www-form-urlencoded',\n                                    Accept: 'application/json',\n                                },\n                                body: `client_id=${encodeURIComponent(CLIENT_ID)}&device_code=${encodeURIComponent(\n                                    message.device_code,\n                                )}&grant_type=urn:ietf:params:oauth:grant-type:device_code`,\n                            },\n                        );\n\n                        if (!resp.ok) {\n                            throw new Error(\n                                `HTTP error! status: ${resp.status}`,\n                            );\n                        }\n\n                        const data: GithubTokenResponse = await resp.json();\n                        sendResponse({ success: true, data });\n                    }\n                } catch (error) {\n                    sendResponse({\n                        success: false,\n                        error:\n                            error instanceof Error\n                                ? error.message\n                                : String(error),\n                    });\n                }\n            })();\n\n            // Required for async sendResponse\n            return true;\n        }\n        if (message.type === 'GITHUB_GIST_API') {\n            (async () => {\n                const token = await getToken();\n                const { action, gistId, payload } = message;\n                const apiUrl = gistId\n                    ? `${GistBaseURL}/${gistId}`\n                    : GistBaseURL;\n                const headers = {\n                    Authorization: `Bearer ${token}`,\n                    Accept: 'application/vnd.github+json',\n                    'Content-Type': 'application/json',\n                };\n\n                if (action === 'findGist') {\n                    const resp = await fetch(apiUrl, {\n                        headers: headers,\n                    });\n                    if (resp.status === 401) {\n                        const data: GithubUnAuthorizedResponse = {\n                            statusCode: resp.status,\n                            ok: resp.ok,\n                        };\n                        sendResponse({ success: true, data: data || null });\n                    }\n                    if (!resp.ok) throw new Error('Failed to fetch gist');\n                    const response: GistResponse = await resp.json();\n                    const content = response.files['settings.json']\n                        .content as string;\n                    const settings = JSON.parse(content) as Settings;\n                    settings.githubSync.gistId = response.id;\n                    const data: GithubAPIResponse = {\n                        gistId: response.id,\n                        url: response.url,\n                        public: response.public,\n                        settings: settings,\n                    };\n                    sendResponse({ success: true, data: data || null });\n                } else if (action === 'createOrUpdateLooiGist') {\n                    const body = {\n                        description: 'Settings for looi extension',\n                        public: payload?.githubSync.publicGist,\n                        files: {\n                            'settings.json': {\n                                content: payload\n                                    ? settingsToJSONString(payload)\n                                    : '',\n                            },\n                        },\n                    };\n                    const resp = await fetch(apiUrl, {\n                        method: gistId ? 'PATCH' : 'POST',\n                        headers: headers,\n                        body: JSON.stringify(body),\n                    });\n                    if (resp.status === 401) {\n                        const data: GithubUnAuthorizedResponse = {\n                            statusCode: resp.status,\n                            ok: resp.ok,\n                        };\n                        sendResponse({ success: true, data: data || null });\n                    }\n                    if (!resp.ok) {\n                        throw new Error(\n                            `GitHub API error: ${resp.status} ${resp.statusText}`,\n                        );\n                    }\n\n                    const response: GistResponse = await resp.json();\n                    const content = response.files['settings.json']\n                        .content as string;\n                    const settings = JSON.parse(content) as Settings;\n                    settings.githubSync.gistId = response.id;\n                    const data: GithubAPIResponse = {\n                        gistId: response.id,\n                        url: response.url,\n                        public: response.public,\n                        settings: settings,\n                    };\n                    sendResponse({ success: resp.ok, data });\n                }\n            })().catch((err) => {\n                sendResponse({\n                    success: false,\n                    error: err instanceof Error ? err.message : String(err),\n                });\n            });\n            return true;\n        }\n        return undefined;\n    },\n);\n"],
  "mappings": "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",
  "names": ["data"]
}
